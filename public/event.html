<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Event Details</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">CharityEvents</a>
      <div class="nav-links">
        <a href="index.html" class="nav-link">Home</a>
        <a href="search.html" class="nav-link">Search Events</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <div class="back-nav">
      <a href="javascript:history.back()" class="back-link">‚Üê Back to Events</a>
    </div>

    <div id="event-detail"></div>

    <!-- Registration List Section -->
    <div class="registrations-section" style="margin-top: 2rem;">
      <h3>Recent Registrations</h3>
      <div id="registrations-list">
      </div>
    </div>

    <div class="register-section">
      <h3>Register for this Event</h3>
      <form id="registerForm">
        <input type="hidden" id="event_id" />
        <label>Full Name:</label>
        <input type="text" id="full_name" required />

        <label>Email:</label>
        <input type="email" id="email" required />

        <label>Phone:</label>
        <input type="text" id="phone" />

        <label>Tickets:</label>
        <input type="number" id="ticket_quantity" value="1" min="1" required />

        <button type="submit" class="btn-primary">Register</button>
      </form>
      <p id="registerMsg"></p>
    </div>
  </div>

  <footer class="footer">
    <div class="container">
      <p>&copy; 2025 CharityEvents. All rights reserved.</p>
    </div>
  </footer>

  <script>
    const eventId = new URLSearchParams(window.location.search).get("id");
    const eventDetail = document.getElementById("event-detail");
    const form = document.getElementById("registerForm");
    const msg = document.getElementById("registerMsg");

    // Get event details
    fetch(`/api/events/${eventId}`)
      .then(res => res.json())
      .then(event => {
        eventDetail.innerHTML = `
          <div class="event-detail">
            <h2>${event.event_name}</h2>
            <p>${event.description}</p>
            <p><strong>Date:</strong> ${new Date(event.event_datetime).toLocaleString()}</p>
            <p><strong>Location:</strong> ${event.location}</p>
            <p><strong>Ticket Price:</strong> $${event.ticket_price}</p>
            <p><strong>Organizer:</strong> ${event.organization_name}</p>
            <p><strong>Goal:</strong> $${event.goal_amount} | <strong>Raised:</strong> $${event.current_amount}</p>
          </div>
        `;
        document.getElementById("event_id").value = event.event_id;
        
        // Load registration list
        loadRegistrations(eventId);
      });

    function loadRegistrations(eventId) {
      fetch(`/api/events/${eventId}/registrations`)
        .then(res => res.json())
        .then(registrations => {
          const registrationsList = document.getElementById('registrations-list');
          
          if (registrations.length === 0) {
            registrationsList.innerHTML = '<p>No registrations yet.</p>';
            return;
          }

          registrationsList.innerHTML = `
            <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid #ddd;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr>
                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Name</th>
                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Email</th>
                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Tickets</th>
                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Total Amount</th>
                    <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Registration Date</th>
                  </tr>
                </thead>
                <tbody>
                  ${registrations.map(reg => `
                    <tr>
                      <td style="padding: 8px; border-bottom: 1px solid #eee;">${reg.full_name}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #eee;">${reg.email}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #eee;">${reg.ticket_quantity}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #eee;">$${reg.total_amount}</td>
                      <td style="padding: 8px; border-bottom: 1px solid #eee;">${new Date(reg.registration_date).toLocaleString()}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        })
        .catch(error => {
          console.error('Error loading registrations:', error);
          document.getElementById('registrations-list').innerHTML = '<p>Error loading registration data.</p>';
        });
    }

    // Registration function
    form.addEventListener("submit", e => {
      e.preventDefault();
      const data = {
        event_id: document.getElementById("event_id").value,
        full_name: document.getElementById("full_name").value,
        email: document.getElementById("email").value,
        phone: document.getElementById("phone").value,
        ticket_quantity: document.getElementById("ticket_quantity").value
      };

      fetch("/api/registrations", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
      })
      .then(res => res.json())
      .then(res => {
        if (res.error) {
          msg.textContent = res.error;
        } else {
          msg.textContent = ` Registration successful! Total: $${res.total_amount}`;
          form.reset();
          loadRegistrations(eventId);
        }
      })
      .catch(() => msg.textContent = " Error occurred while registering.");
    });
  </script>
</body>
</html>
